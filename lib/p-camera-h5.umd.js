/*!
* p-camera-h5 v2.0.0
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-08-01 18:32:30
*/
!function(e,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(e="undefined"!=typeof globalThis?globalThis:e||self).pCameraH5=i()}(this,(function(){"use strict";const e=(...i)=>{const t={};function a(e){return null!==e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)}return i.forEach((i=>{if(a(i))for(const n in i)if(i.hasOwnProperty(n)){const r=i[n],o=t[n];a(r)?(a(o)||(t[n]={}),t[n]=e(o,r)):Array.isArray(r)?t[n]=[...r]:t[n]=r}})),t},i=e=>{const i=document.getElementById("p-error");i.textContent=e,i.style.display="block",console.error(e)},t=async(e,t)=>{const a=e=>new Promise(((i,t)=>{const a=new Image;a.src=e+"?r="+(new Date).getTime(),a.crossOrigin="Anonymous",a.onload=()=>i(a),a.onerror=e=>t(e)}));for(const n of t.watermark)if(n.text&&("string"==typeof n.text&&(n.text={text:n.text,fontSize:20,color:"rgba(255, 255, 255, 0.5)"}),n.text.fontSize&&n.text.fontSize.toString().indexOf("px")>-1&&(n.text.fontSize=parseInt(n.text.fontSize.toString().replace("px","")))),n.img&&("string"==typeof n.img&&(n.img={url:n.img,width:100,height:100}),n.img.url))try{const i=await a(n.img.url);i.width=n.img.width*e.dpr,i.height=n.img.height*e.dpr,i.style.objectFit="contain",i.referrerPolicy="no-referrer",n.img.el=i}catch(e){i("Error accessing media devices: watermark image load error"),console.error(e)}},a=(e,t)=>{if(!e.canvasCtx||!e.mediaStream||!e.video)return i("初始化失败");const a=document.createElement("canvas"),r=e.dpr;a.width=e.video.clientWidth*r,a.height=e.video.clientHeight*r,e.canvasCtx.scale(r,r),e.canvasCtx.imageSmoothingQuality="high",e.canvasCtx.imageSmoothingEnabled=!0;const o=a.captureStream(30);if(t.isAudio){const i=e.mediaStream.getAudioTracks();i.length>0&&o.addTrack(i[0])}const d=document.createElement("video");return d.srcObject=new MediaStream(e.mediaStream.getVideoTracks()),d.onloadedmetadata=()=>{d.play().then((()=>{n(d,e,t)}))},o},n=(e,i,t)=>{if(!i.canvasCtx||!i.video)return;const a=Math.max(i.video.clientWidth/e.videoWidth,i.video.clientHeight/e.videoHeight),o=e.videoWidth*a,d=e.videoHeight*a,s=(i.video.clientWidth-o)/2,c=(i.video.clientHeight-d)/2;i.canvasCtx.drawImage(e,s,c,o,d),t.watermark&&t.watermark.length>0&&r(i,t),i.animationFrameId=requestAnimationFrame((()=>n(e,i,t)))},r=(e,t)=>{if(!e.canvasCtx.canvas)return i("Canvas is not initialized");const a=e.dpr;t.watermark.forEach((i=>{const t=i.x*a,n=i.y*a;e.canvasCtx.save(),e.canvasCtx.scale(1/a,1/a),i.text?(e.canvasCtx.fillStyle=i.text.color,e.canvasCtx.font=i.text.fontSize*a+"px sans-serif",e.canvasCtx.fillText(i.text.text,t,n)):i.img&&i.img.el&&(i.img.el instanceof HTMLImageElement||i.img.el instanceof HTMLCanvasElement||i.img.el instanceof HTMLVideoElement||i.img.el instanceof ImageBitmap?e.canvasCtx.drawImage(i.img.el,t,n,i.img.width*a,i.img.height*a):console.warn("Invalid image source for watermark",i.img.el)),e.canvasCtx.restore()}))};return class{#e;#i={};capture;startRecording;stopRecording;destroy;constructor(t){this.#e=e({el:null,facingMode:"environment",isAudio:!1,watermark:[{x:10,y:10,text:"p-camera-h5"}]},t),this.#t(),this.capture=()=>new Promise(((e,t)=>{if(!this.#i)return i("Media is not initialized");if(!this.#i.canvasCtx)return i("Canvas未初始化");if(!this.#i.video)return i("Video未初始化");const a=document.createElement("canvas");a.width=this.#i.video.videoWidth,a.height=this.#i.video.videoHeight;a.getContext("2d").drawImage(this.#i.canvasCtx.canvas,0,0),e(((e,i)=>{const t=e.split(","),a=t[0].match(/:(.*?);/)[1],n=atob(t[1]);let r=n.length;const o=new Uint8Array(r);for(;r--;)o[r]=n.charCodeAt(r);return new File([o],`pCameraH5-${Date.now()}.${i}`,{type:a})})(a.toDataURL("image/png"),"png"))})),this.startRecording=()=>this.#i?this.#i.recordSecond?console.error("已在录像"):(this.#i.recordedChunks=[],this.#i.canvasStream?(this.#i.mediaRecorder=new MediaRecorder(this.#i.canvasStream),this.#i.mediaRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0){if(!this.#i)return i("Media is not initialized");this.#i.recordedChunks||(this.#i.recordedChunks=[]),this.#i.recordedChunks.push(e.data)}},this.#i.mediaRecorder?(this.#i.mediaRecorder.start(),this.#i.recordSecond=0,void(this.#i.recordTimer=window.setInterval((()=>{this.#i&&void 0!==this.#i.recordSecond&&this.#i.recordSecond++}),1e3))):i("mediaRecorder is required")):i("canvasStream is required")):i("Media is not initialized"),this.stopRecording=()=>new Promise(((e,t)=>this.#i?this.#i.mediaRecorder?(this.#i.mediaRecorder.onstop=()=>{const i=new Blob(this.#i?.recordedChunks,{type:"video/webm"});clearInterval(this.#i?.recordTimer),e(((e,i)=>new File([e],`pCameraH5-${Date.now()}.${i}`,{type:e.type}))(i,"mp4"))},void this.#i.mediaRecorder.stop()):i("mediaRecorder is required"):i("Media is not initialized"))),this.destroy=()=>this.#i?this.#e?this.#e.el?(this.#i.animationFrameId&&cancelAnimationFrame(this.#i.animationFrameId),this.#i.mediaStream?(this.#i.mediaStream.getTracks().forEach((e=>e.stop())),void(this.#e.el.innerHTML="")):i("mediaStream is required")):i("el is required"):i("config is required"):i("media is required")}async#t(){if(!this.#e.el)return console.error("el is required");this.#i||(this.#i={}),this.#i.width=this.#e.el.clientWidth,this.#i.height=this.#e.el.clientHeight,this.#i.dpr=window.devicePixelRatio||1,this.#e.el.innerHTML='\n  <style>\n    #p-camera-h5 {\n      width: 100%;\n      height: 100%;\n      background-color: #000;\n      position: relative;\n      z-index: 100;\n    }\n    #p-camera-h5 #p-loading,\n    #p-camera-h5 #p-error {\n      box-sizing: border-box;\n      width: 100%;\n      height: 100%;\n      padding: 20% 10%;\n      color: #fff;\n      background-color: #000;\n      line-height: 30px;\n      text-align: center;\n      font-size: 16px;\n      position: absolute;\n      top: 0;\n      left: 0;\n      z-index: 110;\n      display: none;\n    }\n    #p-camera-h5 #p-error {\n      z-index: 111;\n    }\n    #p-camera-h5 #p-video {\n      width: 100%;\n      height: 100%;\n      position: absolute;\n      top: 0;\n      left: 0;\n      z-index: 101;\n    }\n  </style>\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <video id="p-video" autoplay playsinline></video>\n  </div>\n';const e=document.getElementById("p-loading");e.style.display="block",await(async(e,n)=>{try{e.video=document.getElementById("p-video");const i=document.createElement("canvas");i.width=e.width,i.height=e.height,e.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:n.facingMode||"environment"},audio:n.isAudio}),e.canvasCtx=i.getContext("2d",{alpha:!1,willReadFrequently:!1}),n.watermark&&await t(e,n),e.canvasStream=a(e,n),e.video.srcObject=e.canvasStream}catch(e){return i("Error accessing media devices: "+e.message)}})(this.#i,this.#e),e.style.display="none"}}}));
