/*!
* p-camera-h5 v1.0.0-beta.4
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-02-25 14:08:10
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).pCameraH5=t()}(this,(function(){"use strict";const e=(e,t)=>{const i=document.createElement("a"),r=URL.createObjectURL(e);i.href=r,i.download=t||e.name,document.body.appendChild(i),i.click(),document.body.removeChild(i)},t=(...e)=>{const i={};function r(e){return null!==e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)}return e.forEach((e=>{if(r(e))for(const n in e)if(e.hasOwnProperty(n)){const a=e[n],s=i[n];r(a)?(r(s)||(i[n]={}),i[n]=t(s,a)):Array.isArray(a)?i[n]=[...a]:i[n]=a}})),i},i=(e,t)=>{throw e.textContent=t,e.style.display="block",new Error(t)},r=(e,t,i,a)=>{if(!t.canvasCtx||!t.video)return;const s=Math.max(t.video.clientWidth/e.videoWidth,t.video.clientHeight/e.videoHeight),o=e.videoWidth*s,d=e.videoHeight*s,c=(t.video.clientWidth-o)/2,h=(t.video.clientHeight-d)/2;t.canvasCtx.drawImage(e,c,h,o,d),n(t,i,a),t.animationFrameId=requestAnimationFrame((()=>r(e,t,i,a)))},n=(e,t,r)=>{if(!1===e.isWatermarkVisible)return;if(!1===t.watermark.visible)return;if(!e.canvasCtx.canvas)return i(r,"Canvas is not initialized");const n=window.devicePixelRatio||1,a=t.watermark.x?t.watermark.x*n:10*n,s=t.watermark.y?t.watermark.y*n:10*n;if(t.watermark.text){let i=20;t.watermark.text.fontSize&&(i=t.watermark.text.fontSize.toString().indexOf("px")>-1?parseInt(t.watermark.text.fontSize.replace("px","")):parseInt(t.watermark.text.fontSize));const r=i*n;e.canvasCtx.save(),e.canvasCtx.scale(1/n,1/n),e.canvasCtx.fillStyle=t.watermark.text.color||"#FFFFFF",e.canvasCtx.font=`${r}px sans-serif`,e.canvasCtx.fillText(t.watermark.text.text,a,s),e.canvasCtx.restore()}if(t.watermark.image){const i=t.watermark.image.width?t.watermark.image.width*n:100*n,r=t.watermark.image.height?t.watermark.image.height*n:100*n;e.canvasCtx.save(),e.canvasCtx.scale(1/n,1/n),e.canvasCtx.drawImage(t.watermark.image.element,a,s,i,r),e.canvasCtx.restore()}},a=async(e,t,n)=>{try{e.video=document.getElementById("p-video");const a=document.getElementById("p-canvas");let s="environment";if(t.facingMode&&(s=t.facingMode),e.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:s},audio:t.isAudio}),e.canvasCtx=a.getContext("2d",{alpha:!1,willReadFrequently:!1}),t.watermark.visible&&t.watermark.image){const e=new Image,r=window.devicePixelRatio||1;e.src=t.watermark.image.url+"?r="+(new Date).getTime(),e.width=(t.watermark.image.width||100)*r,e.height=(t.watermark.image.height||100)*r,e.crossOrigin="Anonymous",e.style.objectFit="contain",e.referrerPolicy="no-referrer",await new Promise((t=>{e.onload=()=>t(e),e.onerror=()=>(i(n,"Error accessing media devices: watermark image load error"),t(e))})),t.watermark.image.element=e}e.canvasStream=((e,t,n)=>{if(!e.canvasCtx||!e.mediaStream)return i(n,"初始化失败");if(!e.video)return i(n,"video is required");const a=document.getElementById("p-canvas"),s=window.devicePixelRatio||1;a.width=e.video.clientWidth*s,a.height=e.video.clientHeight*s,e.canvasCtx.scale(s,s),e.canvasCtx.imageSmoothingQuality="high",e.canvasCtx.imageSmoothingEnabled=!0;const o=a.captureStream(30);if(t.isAudio){const t=e.mediaStream.getAudioTracks();t.length>0&&o.addTrack(t[0])}const d=document.createElement("video");return d.srcObject=new MediaStream(e.mediaStream.getVideoTracks()),d.onloadedmetadata=()=>{d.play().then((()=>{r(d,e,t,n)}))},o})(e,t,n),e.video.srcObject=e.canvasStream}catch(e){return i(n,"Error accessing media devices: "+e.message)}};var s="#p-camera-h5 {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #000;\r\n  position: relative;\r\n}\r\n#p-camera-h5 div {\r\n  box-sizing: border-box;\r\n}\r\n#p-camera-h5 #p-loading,\r\n#p-camera-h5 #p-error {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  background-color: #000;\r\n  color: #fff;\r\n  line-height: 30px;\r\n  text-align: center;\r\n  padding: 50px;\r\n  font-size: 18px;\r\n  z-index: 200;\r\n}\r\n#p-camera-h5 #p-error {\r\n  display: none;\r\n  z-index: 900;\r\n}\r\n\r\n#p-camera-h5 #p-container {\r\n  width: 100%;\r\n  height: calc(100% - 150px);\r\n  position: absolute;\r\n  top: 50px;\r\n  left: 0;\r\n}\r\n#p-camera-h5 #p-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  object-fit: cover;\r\n}\r\n#p-camera-h5 #p-canvas {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n#p-camera-h5 #p-capture-btn,\r\n#p-camera-h5 #p-record-btn {\r\n  width: 80px;\r\n  height: 40px;\r\n  line-height: 40px;\r\n  text-align: center;\r\n  border-radius: 10px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n}\r\n#p-camera-h5 #p-capture-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% - 90px);\r\n}\r\n#p-camera-h5 #p-record-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% + 10px);\r\n}\r\n#p-camera-h5 #p-watermark-btn {\r\n  position: absolute;\r\n  top: 15px;\r\n  right: 10px;\r\n  z-index: 100;\r\n  width: 60px;\r\n  height: 20px;\r\n  line-height: 20px;\r\n  text-align: center;\r\n  border-radius: 5px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n  font-size: 12px;\r\n}\r\n#p-camera-h5 #p-record-time {\r\n  width: 100%;\r\n  position: absolute;\r\n  top: 0px;\r\n  left: 0;\r\n  line-height: 50px;\r\n  color: white;\r\n  font-size: 18px;\r\n  text-align: center;\r\n}\r\n";!function(e,t){void 0===t&&(t={});var i=t.insertAt;if("undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===i&&r.firstChild?r.insertBefore(n,r.firstChild):r.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}(s);return class{#e;#t;#i;#r;#n;api;on;off;constructor(i){this.#e={el:null,facingMode:"environment",isAudio:!1,style:"",watermark:{visible:!1}},this.#e=t(this.#e,i),this.#n=null,this.#t={},this.#i={},this.#r={},this.init(),this.api={init:this.init.bind(this),capture:this.capture.bind(this),startRecording:this.startRecording.bind(this),stopRecording:this.stopRecording.bind(this),destroy:this.destroy.bind(this),downloadFile:e.bind(this)},this.on=(e,t)=>{this.#r[e]=t},this.off=e=>{delete this.#r[e]}}async init(){this.#a(),this.#s(),await a(this.#t,this.#e,this.#n);document.getElementById("p-loading").style.display="none"}#a(){if(!this.#e.el)return console.error("el is required");this.#e.el.innerHTML='\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <div id="p-container">\n      <video id="p-video" autoplay playsinline></video>\n      <canvas id="p-canvas" style="display:none;"></canvas>\n    </div>\n    <div id="p-watermark-btn">关闭水印</div>\n    <div id="p-capture-btn">拍照</div>\n    <div id="p-record-btn">录制</div>\n    <div id="p-record-time">00:00</div>\n  </div>\n',this.#n=document.getElementById("p-error");const e=document.createElement("style");let t=Object.values(s).join("");this.#e.style&&(t+=this.#e.style),e.innerHTML=t,this.#e.el.appendChild(e)}#s(){if(this.#i||(this.#i={}),this.#i.watermarkBtn=document.getElementById("p-watermark-btn"),this.#i.captureBtn=document.getElementById("p-capture-btn"),this.#i.recordBtn=document.getElementById("p-record-btn"),!this.#i.watermarkBtn||!this.#i.captureBtn||!this.#i.recordBtn)return i(this.#n,"Buttons not initialized");this.#e.watermark&&this.#e.watermark.visible?this.#i.watermarkBtn.addEventListener("click",(()=>this.handleWatermark())):this.#i.watermarkBtn.style.display="none",this.#i.captureBtn.addEventListener("click",(()=>this.handleCapture())),this.#i.recordBtn.addEventListener("click",(()=>this.handleRecording()))}capture(){if(!this.#t)return i(this.#n,"Media is not initialized");if(!this.#t.canvasCtx)return i(this.#n,"Canvas未初始化");if(!this.#t.video)return i(this.#n,"Video未初始化");const e=document.createElement("canvas");e.width=this.#t.video.videoWidth,e.height=this.#t.video.videoHeight;e.getContext("2d").drawImage(this.#t.canvasCtx.canvas,0,0),this.#r&&this.#r.capture&&this.#r.capture(((e,t)=>{const i=e.split(","),r=i[0].match(/:(.*?);/)[1],n=atob(i[1]);let a=n.length;const s=new Uint8Array(a);for(;a--;)s[a]=n.charCodeAt(a);return new File([s],`pCameraH5-${Date.now()}.${t}`,{type:r})})(e.toDataURL("image/png"),"png"))}startRecording(){if(!this.#t)return i(this.#n,"Media is not initialized");if(this.#t.recordedChunks=[],!this.#t.canvasStream)return i(this.#n,"canvasStream is required");if(this.#t.mediaRecorder=new MediaRecorder(this.#t.canvasStream),this.#t.mediaRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0){if(!this.#t)return i(this.#n,"Media is not initialized");this.#t.recordedChunks||(this.#t.recordedChunks=[]),this.#t.recordedChunks.push(e.data)}},!this.#t.mediaRecorder)return i(this.#n,"mediaRecorder is required");if(this.#t.mediaRecorder.start(),this.#t.recordTime=document.getElementById("p-record-time"),!this.#t.recordTime)return i(this.#n,"recordTime is required");if(!this.#t.recordTime)return i(this.#n,"recordTime is required");this.#t.recordTime.style.display="inline";let e=0;this.#t.recordTimer=window.setInterval((()=>(e++,this.#t&&this.#t.recordTime?(e>=60&&this.stopRecording(),void(this.#t.recordTime.textContent=`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`)):i(this.#n,"recordTime is required"))),1e3)}async stopRecording(){return this.#t?this.#t.mediaRecorder?(this.#t.mediaRecorder.onstop=()=>{if(!this.#t)return i(this.#n,"Media is not initialized");const e=new Blob(this.#t.recordedChunks,{type:"video/webm"});if(this.#r&&this.#r.record&&this.#r.record(((e,t)=>new File([e],`pCameraH5-${Date.now()}.${t}`,{type:e.type}))(e,"mp4")),!this.#t.recordTime||!this.#t.recordTimer)return i(this.#n,"recordTime is required");clearInterval(this.#t.recordTimer),this.#t.recordTime.textContent="00:00"},void this.#t.mediaRecorder.stop()):i(this.#n,"mediaRecorder is required"):i(this.#n,"Media is not initialized")}handleWatermark(){return this.#t?this.#i?this.#i.watermarkBtn?(null!==this.#t.isWatermarkVisible&&void 0!==this.#t.isWatermarkVisible||(this.#t.isWatermarkVisible=!0),this.#t.isWatermarkVisible=!this.#t.isWatermarkVisible,void(this.#i.watermarkBtn.textContent=this.#t.isWatermarkVisible?"关闭水印":"打开水印")):i(this.#n,"watermarkBtn is required"):i(this.#n,"btns is required"):i(this.#n,"media is required")}handleCapture(){this.capture()}async handleRecording(){return this.#i?this.#i.recordBtn?void("录制"===this.#i.recordBtn.textContent?(this.startRecording(),this.#i.recordBtn.textContent="停止"):(await this.stopRecording(),this.#i.recordBtn.textContent="录制")):i(this.#n,"recordBtn is required"):i(this.#n,"btns is required")}destroy(){return this.#t?this.#e?this.#e.el?(this.#t.animationFrameId&&cancelAnimationFrame(this.#t.animationFrameId),this.#t.mediaStream?(this.#t.mediaStream.getTracks().forEach((e=>e.stop())),this.#e.el.innerHTML="",void(this.#i&&(this.#e.watermark&&this.#e.watermark.visible&&this.#i.watermarkBtn?.removeEventListener("click",this.handleWatermark),this.#i.captureBtn?.removeEventListener("click",this.handleCapture),this.#i.recordBtn?.removeEventListener("click",this.handleRecording)))):i(this.#n,"mediaStream is required")):i(this.#n,"el is required"):i(this.#n,"config is required"):i(this.#n,"media is required")}}}));
