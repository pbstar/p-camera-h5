/*!
* p-camera-h5 v2.0.0
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-07-31 22:35:47
*/
const e=(...i)=>{const t={};function a(e){return null!==e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)}return i.forEach((i=>{if(a(i))for(const n in i)if(i.hasOwnProperty(n)){const r=i[n],d=t[n];a(r)?(a(d)||(t[n]={}),t[n]=e(d,r)):Array.isArray(r)?t[n]=[...r]:t[n]=r}})),t},i=e=>{const i=document.getElementById("p-error");i.textContent=e,i.style.display="block",console.error(e)},t=(e,i,n)=>{if(!i.canvasCtx||!i.video)return;const r=Math.max(i.video.clientWidth/e.videoWidth,i.video.clientHeight/e.videoHeight),d=e.videoWidth*r,o=e.videoHeight*r,s=(i.video.clientWidth-d)/2,c=(i.video.clientHeight-o)/2;i.canvasCtx.drawImage(e,s,c,d,o),n.watermark&&n.watermark.length>0&&a(i,n),i.animationFrameId=requestAnimationFrame((()=>t(e,i,n)))},a=(e,t)=>{if(!e.canvasCtx.canvas)return i("Canvas is not initialized");const a=e.dpr;t.watermark.forEach((i=>{const t=i.x*a,n=i.y*a;e.canvasCtx.save(),e.canvasCtx.scale(1/a,1/a),i.text?(e.canvasCtx.fillStyle=i.text.color,e.canvasCtx.font=i.text.fontSize*a+"px sans-serif",e.canvasCtx.fillText(i.text.text,t,n)):i.img&&e.canvasCtx.drawImage(i.img.el,t,n,i.img.width*a,i.img.height*a),e.canvasCtx.restore()}))},n=async(e,a)=>{try{e.video=document.getElementById("p-video");const n=document.createElement("canvas");n.width=e.width,n.height=e.height,e.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:a.facingMode||"environment"},audio:a.isAudio}),e.canvasCtx=n.getContext("2d",{alpha:!1,willReadFrequently:!1}),a.watermark&&a.watermark.forEach((e=>{if(e.text&&("string"==typeof e.text&&(e.text={text:e.text,fontSize:20,color:"rgba(255, 255, 255, 0.5)"}),e.text.fontSize.toString().indexOf("px")>-1&&(e.text.fontSize=parseInt(e.text.fontSize.toString().replace("px","")))),e.img&&("string"==typeof e.img&&(e.img={url:e.img,width:100,height:100}),e.img.url)){const i=new Image;i.src=e.img.url,e.img.el=i}})),e.canvasStream=((e,a)=>{if(!e.canvasCtx||!e.mediaStream||!e.video)return i("初始化失败");const n=document.createElement("canvas"),r=e.dpr;n.width=e.video.clientWidth*r,n.height=e.video.clientHeight*r,e.canvasCtx.scale(r,r),e.canvasCtx.imageSmoothingQuality="high",e.canvasCtx.imageSmoothingEnabled=!0;const d=n.captureStream(30);if(a.isAudio){const i=e.mediaStream.getAudioTracks();i.length>0&&d.addTrack(i[0])}const o=document.createElement("video");return o.srcObject=new MediaStream(e.mediaStream.getVideoTracks()),o.onloadedmetadata=()=>{o.play().then((()=>{t(o,e,a)}))},d})(e,a),e.video.srcObject=e.canvasStream}catch(e){return i("Error accessing media devices: "+e.message)}};class r{#e;#i;constructor(i){this.#e=e({el:null,facingMode:"environment",isAudio:!1,watermark:[{x:10,y:10,text:{value:"p-camera-h5",color:"rgba(255, 255, 255, 0.5)",fontSize:16}}]},i),this.#i={},this.#t()}async#t(){if(!this.#e.el)return console.error("el is required");this.#i||(this.#i={}),this.#i.width=this.#e.el.clientWidth,this.#i.height=this.#e.el.clientHeight,this.#i.dpr=window.devicePixelRatio||1,this.#e.el.innerHTML='\n  <style>\n    #p-camera-h5 {\n      width: 100%;\n      height: 100%;\n      background-color: #000;\n      position: relative;\n      z-index: 100;\n    }\n    #p-camera-h5 #p-loading,\n    #p-camera-h5 #p-error {\n      box-sizing: border-box;\n      width: 100%;\n      height: 100%;\n      padding: 20% 10%;\n      color: #fff;\n      background-color: #000;\n      line-height: 30px;\n      text-align: center;\n      font-size: 16px;\n      position: absolute;\n      top: 0;\n      left: 0;\n      z-index: 110;\n      display: none;\n    }\n    #p-camera-h5 #p-error {\n      z-index: 111;\n    }\n    #p-camera-h5 #p-video {\n      width: 100%;\n      height: 100%;\n      position: absolute;\n      top: 0;\n      left: 0;\n      z-index: 101;\n    }\n  </style>\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <video id="p-video" autoplay playsinline></video>\n  </div>\n';const e=document.getElementById("p-loading");e.style.display="block",await n(this.#i,this.#e),e.style.display="none"}capture(){if(!this.#i)return i("Media is not initialized");if(!this.#i.canvasCtx)return i("Canvas未初始化");if(!this.#i.video)return i("Video未初始化");const e=document.createElement("canvas");e.width=this.#i.video.videoWidth,e.height=this.#i.video.videoHeight;return e.getContext("2d").drawImage(this.#i.canvasCtx.canvas,0,0),((e,i)=>{const t=e.split(","),a=t[0].match(/:(.*?);/)[1],n=atob(t[1]);let r=n.length;const d=new Uint8Array(r);for(;r--;)d[r]=n.charCodeAt(r);return new File([d],`pCameraH5-${Date.now()}.${i}`,{type:a})})(e.toDataURL("image/png"),"png")}startRecording(){if(!this.#i)return i("Media is not initialized");if(this.#i.recordedChunks=[],!this.#i.canvasStream)return i("canvasStream is required");if(this.#i.mediaRecorder=new MediaRecorder(this.#i.canvasStream),this.#i.mediaRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0){if(!this.#i)return i("Media is not initialized");this.#i.recordedChunks||(this.#i.recordedChunks=[]),this.#i.recordedChunks.push(e.data)}},!this.#i.mediaRecorder)return i("mediaRecorder is required");if(this.#i.mediaRecorder.start(),this.#i.recordTime=document.getElementById("p-record-time"),!this.#i.recordTime)return i("recordTime is required");if(!this.#i.recordTime)return i("recordTime is required");this.#i.recordTime.style.display="inline";let e=0;this.#i.recordTimer=window.setInterval((()=>(e++,this.#i&&this.#i.recordTime?(e>=60&&this.stopRecording(),void(this.#i.recordTime.textContent=`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`)):i("recordTime is required"))),1e3)}async stopRecording(){return new Promise(((e,t)=>this.#i?this.#i.mediaRecorder?(this.#i.mediaRecorder.onstop=()=>{if(!this.#i)return i("Media is not initialized");const t=new Blob(this.#i.recordedChunks,{type:"video/webm"});if(e(((e,i)=>new File([e],`pCameraH5-${Date.now()}.${i}`,{type:e.type}))(t,"mp4")),!this.#i.recordTime||!this.#i.recordTimer)return i("recordTime is required");clearInterval(this.#i.recordTimer),this.#i.recordTime.textContent="00:00"},void this.#i.mediaRecorder.stop()):i("mediaRecorder is required"):i("Media is not initialized")))}destroy(){return this.#i?this.#e?this.#e.el?(this.#i.animationFrameId&&cancelAnimationFrame(this.#i.animationFrameId),this.#i.mediaStream?(this.#i.mediaStream.getTracks().forEach((e=>e.stop())),void(this.#e.el.innerHTML="")):i("mediaStream is required")):i("el is required"):i("config is required"):i("media is required")}}export{r as default};
